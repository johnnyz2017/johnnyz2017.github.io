<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta http-equiv="origin-trial" data-feature="WebVR (For Chrome M59+)" data-expires="2017-08-30" content="AmtVcdkEen4LWNSpr4fW02Z0wHiaM9p8no5KyO0jx70aZNWvoIFxwBHG8RPTVjbrgrYCxFQvYwAndg60tl3XVAYAAABMeyJvcmlnaW4iOiJodHRwczovL3dlYnZyLmluZm86NDQzIiwiZmVhdHVyZSI6IldlYlZSMS4xIiwiZXhwaXJ5IjoxNTA0MTI1ODEyfQ==">

    <title>webvr - 360 demo</title>
    <style>
      #webgl-canvas {
        box-sizing: border-box;
        height: 100%;
        left: 0;
        margin: 0;
        position: absolute;
        top: 0;
        width: 100%;
      }
    </style>

    <script>
      var WebVRConfig = {
        DEFER_INITIALIZATION: true,
        POLYFILL_MODE: "ALWAYS",
        DIRTY_SUBMIT_FRAME_BINDINGS: true,
        BUFFER_SCALE: 0.75,
      };
    </script>
    <script src="js/webvr-polyfill.js"></script>
    <script src="js/wglu-url.js"></script>
    <script>
      if (WGLUUrl.getBool('polyfill', false)) {
        InitializeWebVRPolyfill();
      }
    </script>
    <script src="js/gl-matrix-min.js"></script>
    <script src="js/wglu-program.js"></script>
    <script src="js/vr-panorama.js"></script>
    <script src="js/vr-samples-util.js"></script>
  </head>
  <body>
    <canvas id="webgl-canvas"></canvas>
    <script>
      (function () {
      "use strict";

      var vrDisplay = null;
      var frameData = null;
      var projectionMat = mat4.create();
      var poseMat = mat4.create();
      var viewMat = mat4.create();
      var vrPresentButton = null;

      var webglCanvas = document.getElementById("webgl-canvas");
      var gl = null;
      var panorama = null;

      function init (preserveDrawingBuffer) {
        var glAttribs = {
          alpha: false,
          antialias: false,
          preserveDrawingBuffer: preserveDrawingBuffer
        };
        gl = webglCanvas.getContext("webgl", glAttribs);
        if (!gl) {
          gl = webglCanvas.getContext("experimental-webgl", glAttribs);
          if (!gl) {
            VRSamplesUtil.addError("Your browser does not support WebGL.");
            return;
          }
        }
        gl.enable(gl.DEPTH_TEST);
        gl.enable(gl.CULL_FACE);

        panorama = new VRPanorama(gl);
        panorama.setImage("images/test.jpg");

        var enablePerformanceMonitoring = WGLUUrl.getBool(
            'enablePerformanceMonitoring', false);

        window.addEventListener("resize", onResize, false);
        onResize();
        window.requestAnimationFrame(onAnimationFrame);
      }


      function onVRRequestPresent () {
        vrDisplay.requestPresent([{ source: webglCanvas }]).then(function () {
        }, function (err) {
          var errMsg = "requestPresent failed.";
          if (err && err.message) {
            errMsg += "<br/>" + err.message
          }
          VRSamplesUtil.addError(errMsg, 2000);
        });
      }

      function onVRExitPresent () {
        if (!vrDisplay.isPresenting)
          return;

        vrDisplay.exitPresent().then(function () {
        }, function () {
          VRSamplesUtil.addError("exitPresent failed.", 2000);
        });
      }

      function onVRPresentChange () {
        onResize();

        if (vrDisplay.isPresenting) {
          if (vrDisplay.capabilities.hasExternalDisplay) {
            VRSamplesUtil.removeButton(vrPresentButton);
            vrPresentButton = VRSamplesUtil.addButton("Exit VR", "E", "images/cardboard64.png", onVRExitPresent);
          }
        } else {
          if (vrDisplay.capabilities.hasExternalDisplay) {
            VRSamplesUtil.removeButton(vrPresentButton);
            vrPresentButton = VRSamplesUtil.addButton("Enter VR", "E", "images/cardboard64.png", onVRRequestPresent);
          }
        }
      }

      if (navigator.getVRDisplays) {
        frameData = new VRFrameData();

        navigator.getVRDisplays().then(function (displays) {
          if (displays.length > 0) {
            vrDisplay = displays[displays.length - 1];
            vrDisplay.depthNear = 0.1;
            vrDisplay.depthFar = 1024.0;

            init(true);

            if (vrDisplay.capabilities.canPresent)
              vrPresentButton = VRSamplesUtil.addButton("Enter VR", "E", "images/cardboard64.png", onVRRequestPresent);

            if (vrDisplay.capabilities.canPresent && WGLUUrl.getBool('canvasClickPresents', false))
              webglCanvas.addEventListener("click", onVRRequestPresent, false);

            window.addEventListener('vrdisplaypresentchange', onVRPresentChange, false);
            window.addEventListener('vrdisplayactivate', onVRRequestPresent, false);
            window.addEventListener('vrdisplaydeactivate', onVRExitPresent, false);
          } else {
            init(false);
            VRSamplesUtil.addInfo("WebVR supported, but no VRDisplays found.", 3000);
          }
        });
      } else if (navigator.getVRDevices) {
        init(false);
        VRSamplesUtil.addError("Your browser supports WebVR but not the latest version.");
      } else {
        init(false);
        VRSamplesUtil.addError("Your browser does not support WebVR.");
      }

      function onResize () {
        if (vrDisplay && vrDisplay.isPresenting) {
          var leftEye = vrDisplay.getEyeParameters("left");
          var rightEye = vrDisplay.getEyeParameters("right");

          webglCanvas.width = Math.max(leftEye.renderWidth, rightEye.renderWidth) * 2;
          webglCanvas.height = Math.max(leftEye.renderHeight, rightEye.renderHeight);
        } else {
          webglCanvas.width = webglCanvas.offsetWidth * window.devicePixelRatio;
          webglCanvas.height = webglCanvas.offsetHeight * window.devicePixelRatio;
        }
      }

      function getPoseMatrix (out, pose) {
        var orientation = pose.orientation;
        if (!orientation) { orientation = [0, 0, 0, 1]; }
        mat4.fromQuat(out, orientation);
        mat4.invert(out, out);
      }

      function onAnimationFrame (t) {
        gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);

        if (vrDisplay) {
          vrDisplay.requestAnimationFrame(onAnimationFrame);

          vrDisplay.getFrameData(frameData);

          getPoseMatrix(viewMat, frameData.pose);

          if (vrDisplay.isPresenting) {
            gl.viewport(0, 0, webglCanvas.width * 0.5, webglCanvas.height);
            panorama.render(frameData.leftProjectionMatrix, viewMat);

            gl.viewport(webglCanvas.width * 0.5, 0, webglCanvas.width * 0.5, webglCanvas.height);
            panorama.render(frameData.rightProjectionMatrix, viewMat);

            vrDisplay.submitFrame();
          } else {
            gl.viewport(0, 0, webglCanvas.width, webglCanvas.height);
            mat4.perspective(projectionMat, Math.PI*0.4, webglCanvas.width / webglCanvas.height, 0.1, 1024.0);
            panorama.render(projectionMat, viewMat);
          }
        } else {
          window.requestAnimationFrame(onAnimationFrame);
          gl.viewport(0, 0, webglCanvas.width, webglCanvas.height);
          mat4.perspective(projectionMat, Math.PI*0.4, webglCanvas.width / webglCanvas.height, 0.1, 1024.0);
          mat4.identity(viewMat);
          panorama.render(projectionMat, viewMat);
        }
      }
      })();
    </script>
  </body>
</html>
